<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Intelligent Marketplace</title>
  <style>
    body { font-family: Arial, sans-serif; background:#f5f5f5; margin:0; padding:20px; }
    .container { max-width:700px; margin:auto; background:#fff; padding:20px; border-radius:10px; box-shadow:0 6px 20px rgba(0,0,0,0.05); }
    h2 { text-align:center; margin-top:0; }
    .status { padding:10px; margin:10px 0; border-radius:6px; display:none; font-weight:600; }
    .loading { background:#fff3cd; color:#856404; }
    .success { background:#d4edda; color:#155724; }
    .error { background:#f8d7da; color:#721c24; }
    .muted { color:#666; font-size:13px; }
    label { display:block; margin-top:12px; font-weight:600; }
    input, textarea { width:100%; padding:10px; margin-top:6px; border:1px solid #ccc; border-radius:6px; font-size:14px; box-sizing:border-box; }
    button { padding:10px 14px; margin-top:12px; background:#007bff; color:white; border:none; border-radius:6px; cursor:pointer; font-weight:700; }
    #submitAnother { display:none; margin-top:20px; background:#28a745; }
    #removeAds { display:block; margin-bottom:15px; background:#dc3545; }
    #userInfo { padding:10px; margin-bottom:15px; background:#e9ecef; border-radius:6px; font-weight:600; text-align:center; }
  </style>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
</head>
<body>
  <div class="container">
    <h2>Intelligent Marketplace</h2>

    <div id="userInfo"></div>
    <div id="status" class="status"></div>

    <button id="removeAds">Remove Ads / Go Premium</button>

    <form id="product-form">
      <h3>Sell a Product</h3>
      <label>Product Images (1-5)</label>
      <input type="file" id="productImage" required multiple>
      <label>Product Name</label>
      <input type="text" id="productName" required>
      <label>Description</label>
      <textarea id="productDesc" required></textarea>
      <label>Price</label>
      <input type="text" id="productPrice" placeholder="₦2000 or $5" required>
      <label>WhatsApp Number</label>
      <input type="text" id="whatsapp" required>
      <label>Contact link</label>
      <input type="url" id="contact_link" required>
      <button type="submit">Submit Product</button>
    </form>

    <button id="submitAnother">Submit Another Product</button>
  </div>

  <script src='//libtl.com/sdk.js' data-zone='9830606' data-sdk='show_9830606'></script>
  <script src="premium.js"></script>

  <script>
const DEFAULT_BOT_TOKEN = "7514817340:AAHUpE5ZPEUZkkM4rq4smoV_nzWfmwWBVGc";
const ADMIN_ID = "6976365864";

const tg = window.Telegram.WebApp;
tg.expand();

const TELEGRAM_USER_ID = tg.initDataUnsafe?.user?.id || "000";
const TELEGRAM_USER_NAME =
  (tg.initDataUnsafe?.user?.first_name || "") +
  (tg.initDataUnsafe?.user?.last_name ? " " + tg.initDataUnsafe.user.last_name : "") ||
  "John Doe";

document.getElementById("userInfo").textContent =
  `Logged in as: ${TELEGRAM_USER_NAME} (ID: ${TELEGRAM_USER_ID})`;

const statusBox = document.getElementById("status");
const submitAnotherBtn = document.getElementById("submitAnother");
const removeAdsBtn = document.getElementById("removeAds");
const productForm = document.getElementById("product-form");

function showStatus(type, msg, autoHide = 0) {
  statusBox.className = "status " + type;
  statusBox.textContent = msg;
  statusBox.style.display = "block";
  if (autoHide) setTimeout(() => statusBox.style.display = "none", autoHide);
}

if (typeof premiumUsers !== "undefined" && premiumUsers.includes(TELEGRAM_USER_ID)) {
  removeAdsBtn.style.display = "none";
}

function showAdIfNotPremium() {
  try {
    if (typeof show_9830606 === "function" && (!premiumUsers || !premiumUsers.includes(TELEGRAM_USER_ID))) {
      show_9830606();
    }
  } catch (e) { console.error("Ad error:", e); }
}
window.addEventListener("load", showAdIfNotPremium);

productForm.addEventListener("submit", async function (e) {
  e.preventDefault();

  const name = document.getElementById("productName").value.trim();
  const desc = document.getElementById("productDesc").value.trim();
  const price = document.getElementById("productPrice").value.trim();
  const whatsapp = document.getElementById("whatsapp").value.trim();
  const contact = document.getElementById("contact_link").value.trim();
  const files = [...document.getElementById("productImage").files];

  if (!name || !desc || !price || !whatsapp || !contact || files.length === 0) {
    return showStatus("error", "Please fill all fields and select at least one file", 3000);
  }

  showStatus("loading", "Submitting your product... please wait");

  // formatted Telegram message
  const textMsg =
    `🛍️ *NEW PRODUCT SUBMISSION*\n\n` +
    `📄 *Page:* ${document.title}\n` +
    `👤 *User:* ${TELEGRAM_USER_NAME}\n` +
    `🆔 *Telegram ID:* ${TELEGRAM_USER_ID}\n\n` +
    `📦 *Product Name:* ${name}\n` +
    `📝 *Description:* ${desc}\n` +
    `💲 *Price:* ${price}\n` +
    `📱 *WhatsApp:* ${whatsapp}\n` +
    `🔗 *Contact Link:* ${contact}\n\n` +
    `✅ _Submitted via Intelligent Marketplace WebApp_`;

  try {
    // send message to admin
    await fetch(`https://api.telegram.org/bot${DEFAULT_BOT_TOKEN}/sendMessage`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        chat_id: ADMIN_ID,
        text: textMsg,
        parse_mode: "Markdown"
      })
    });

    // send uploaded product photos to admin
    for (const file of files) {
      const photoData = new FormData();
      photoData.append("chat_id", ADMIN_ID);
      photoData.append("photo", file);
      await fetch(`https://api.telegram.org/bot${DEFAULT_BOT_TOKEN}/sendPhoto`, {
        method: "POST",
        body: photoData
      });
    }

    // confirmation message to user
    await fetch(`https://api.telegram.org/bot${DEFAULT_BOT_TOKEN}/sendMessage`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        chat_id: TELEGRAM_USER_ID,
        text: `✅ *Your product has been submitted successfully!*\n\n` +
              `🧾 *Name:* ${name}\n` +
              `💲 *Price:* ${price}\n` +
              `🕒 Admin will review it shortly.`,
        parse_mode: "Markdown"
      })
    });

    showStatus("success", "Product sent successfully! Admin is reviewing your product.", 5000);
    productForm.style.display = "none";
    submitAnotherBtn.style.display = "block";
    showAdIfNotPremium();
  } catch (err) {
    console.error(err);
    showStatus("error", "❌ Error sending product", 4000);
  }
});

submitAnotherBtn.addEventListener("click", () => {
  productForm.reset();
  productForm.style.display = "block";
  submitAnotherBtn.style.display = "none";
  showAdIfNotPremium();
});

removeAdsBtn.addEventListener("click", () => {
  window.location.href = `premium.html?user=${TELEGRAM_USER_ID}&name=${encodeURIComponent(TELEGRAM_USER_NAME)}`;
});
  </script>
</body>
</html>