<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Intelligent Marketplace</title>
  <style>
    body { font-family: Arial, sans-serif; background:#f5f5f5; margin:0; padding:20px; }
    .container { max-width:700px; margin:auto; background:#fff; padding:20px; border-radius:10px; box-shadow:0 6px 20px rgba(0,0,0,0.05); }
    h2 { text-align:center; margin-top:0; }
    .status { padding:10px; margin:10px 0; border-radius:6px; display:none; font-weight:600; }
    .loading { background:#fff3cd; color:#856404; }
    .success { background:#d4edda; color:#155724; }
    .error { background:#f8d7da; color:#721c24; }
    .muted { color:#666; font-size:13px; }
    label { display:block; margin-top:12px; font-weight:600; }
    input, textarea { width:100%; padding:10px; margin-top:6px; border:1px solid #ccc; border-radius:6px; font-size:14px; box-sizing:border-box; }
    button { padding:10px 14px; margin-top:12px; background:#007bff; color:white; border:none; border-radius:6px; cursor:pointer; font-weight:700; }
    #submitAnother { display:none; margin-top:20px; background:#28a745; }
    #removeAds { display:block; margin-bottom:15px; background:#dc3545; }
    #userInfo { padding:10px; margin-bottom:15px; background:#e9ecef; border-radius:6px; font-weight:600; }
  </style>
</head>
<body>
  <div class="container">
    <h2>Intelligent Marketplace</h2>

    <!-- User info display -->
    <div id="userInfo"></div>

    <div id="status" class="status"></div>

    <!-- Remove Ads button -->
    <button id="removeAds">Remove Ads / Go Premium</button>

    <!-- Product form -->
    <form id="product-form">
      <h3>Sell a Product</h3>
      <label>Product Images (1-5)</label>
      <input type="file" id="productImage" required multiple>
      <label>Product Name</label>
      <input type="text" id="productName" required>
      <label>Description</label>
      <textarea id="productDesc" required></textarea>
      <label>Price</label>
      <input type="text" id="productPrice" placeholder="â‚¦2000 or $5" required>
      <label>WhatsApp Number</label>
      <input type="text" id="whatsapp" required>
      <label>Contact link</label>
      <input type="url" id="contact_link" required>
      <button type="submit">Submit Product</button>
    </form>

    <!-- Submit another product -->
    <button id="submitAnother">Submit Another Product</button>
  </div>

  <!-- Ads SDK -->
  <script src='//libtl.com/sdk.js' data-zone='9830606' data-sdk='show_9830606'></script>

  <!-- Premium users list -->
  <script src="premium.js"></script>

<script>
  const BOT_TOKEN = "7514817340:AAHUpE5ZPEUZkkM4rq4smoV_nzWfmwWBVGc";
  const ADMIN_ID = "6976365864";

  // --- Dynamic Telegram user info ---
  const TELEGRAM_USER_ID = Telegram.WebApp.initDataUnsafe?.user?.id || "000";
  const TELEGRAM_USER_NAME = (Telegram.WebApp.initDataUnsafe?.user?.first_name || "") + 
                             (Telegram.WebApp.initDataUnsafe?.user?.last_name ? " " + Telegram.WebApp.initDataUnsafe.user.last_name : "") || "John Doe";
  // ----------------------------------

  const statusBox = document.getElementById("status");
  const submitAnotherBtn = document.getElementById("submitAnother");
  const removeAdsBtn = document.getElementById("removeAds");
  const productForm = document.getElementById("product-form");
  const userInfoDiv = document.getElementById("userInfo");

  // Display correct Telegram user info
  userInfoDiv.textContent = `Logged in as: ${TELEGRAM_USER_NAME} (ID: ${TELEGRAM_USER_ID})`;

  function showStatus(type, msg, autoHide=0){
    statusBox.className = "status " + type;
    statusBox.textContent = msg;
    statusBox.style.display = "block";
    if(autoHide) setTimeout(()=>statusBox.style.display="none", autoHide);
  }

  // Hide Remove Ads button if user is premium
  if(premiumUsers.includes(TELEGRAM_USER_ID)){
    removeAdsBtn.style.display = "none";
  } else {
    removeAdsBtn.style.display = "block";
  }

  // Show ads only for non-premium users
  function showAdIfNotPremium() {
    try {
      if(typeof show_9830606 === "function" && !premiumUsers.includes(TELEGRAM_USER_ID)){
        show_9830606();
      }
    } catch(e) { console.error(e); }
  }

  // Show ad on page load if not premium
  window.addEventListener("load", showAdIfNotPremium);

  // Product form submit
  productForm.addEventListener("submit", async function(e){
    e.preventDefault();
    const files = [...document.getElementById("productImage").files].slice(0,5);
    if(files.length===0) return showStatus("error","Upload at least one image",3000);

    const name = document.getElementById("productName").value.trim();
    const desc = document.getElementById("productDesc").value.trim();
    const price = document.getElementById("productPrice").value.trim();
    const whatsapp = document.getElementById("whatsapp").value.trim();
    const contact = document.getElementById("contact_link").value.trim();

    const caption = `ðŸ“¦ New Product\nName: ${name}\nDesc: ${desc}\nPrice: ${price}\nWhatsApp: ${whatsapp}\nLink: ${contact}`;

    try{
      for(const file of files){
        const fd = new FormData();
        fd.append("chat_id", ADMIN_ID);
        fd.append("caption", caption);
        if(file.type.startsWith("image/")) fd.append("photo", file), await fetch(`https://api.telegram.org/bot${BOT_TOKEN}/sendPhoto`,{method:"POST",body:fd});
        else fd.append("document", file), await fetch(`https://api.telegram.org/bot${BOT_TOKEN}/sendDocument`,{method:"POST",body:fd});
      }
      showStatus("success","Product sent to admin",4000);
      productForm.style.display = "none";
      submitAnotherBtn.style.display = "block";

      // Show ad after successful submission if not premium
      showAdIfNotPremium();

    } catch(err){
      showStatus("error","Error sending product",4000);
    }
  });

  // Submit another product button
  submitAnotherBtn.addEventListener("click", () => {
    productForm.reset();
    productForm.style.display = "block";
    submitAnotherBtn.style.display = "none";

    // Show ad when clicking "Submit Another Product" if not premium
    showAdIfNotPremium();
  });

  // Remove Ads button
  removeAdsBtn.addEventListener("click", () => {
    window.location.href = `premium.html?user=${TELEGRAM_USER_ID}&name=${encodeURIComponent(TELEGRAM_USER_NAME)}`;
  });
</script>
</body>
</html>